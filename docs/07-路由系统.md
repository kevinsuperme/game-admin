# 路由结构文档

## 路由系统概述

本项目的路由系统基于 Vue Router 4 实现，支持多种路由模式和权限控制。路由系统分为固定路由、系统路由和动态路由三种类型，并支持基于前端、后端或文件系统的路由生成方式。

## 路由类型

### 1. 固定路由 (constantRoutes)

固定路由是不需要权限验证的路由，所有用户都可以访问：

```javascript
const constantRoutes: RouteRecordRaw[] = [
  {
    path: '/login',
    name: 'login',
    component: () => import('@/views/login.vue'),
    meta: {
      title: '登录',
    },
  },
  {
    path: '/:all(.*)*',
    name: 'notFound',
    component: () => import('@/views/[...all].vue'),
    meta: {
      title: '找不到页面',
    },
  },
]
```

固定路由包括：
- **登录页面**: `/login` - 用户登录入口
- **404页面**: `/:all(.*)*` - 处理未匹配的路由

### 2. 系统路由 (systemRoutes)

系统路由是应用核心功能路由，通常需要登录后访问：

```javascript
const systemRoutes: RouteRecordRaw[] = [
  {
    path: '/',
    component: () => import('@/layouts/index.vue'),
    meta: {
      title: () => useSettingsStore().settings.home.title,
      breadcrumb: false,
    },
    children: [
      {
        path: '',
        component: () => import('@/views/index.vue'),
        meta: {
          title: () => useSettingsStore().settings.home.title,
          icon: 'i-ant-design:home-twotone',
          breadcrumb: false,
        },
      },
      {
        path: 'reload',
        name: 'reload',
        component: () => import('@/views/reload.vue'),
        meta: {
          title: '重新加载',
          breadcrumb: false,
        },
      },
    ],
  },
]
```

系统路由包括：
- **首页**: `/` - 应用主页
- **重新加载**: `/reload` - 用于刷新页面

### 3. 动态路由 (asyncRoutes)

动态路由是根据用户权限动态生成的路由，用于构建导航菜单：

```javascript
const asyncRoutes: Route.recordMainRaw[] = [
  {
    meta: {
      title: '演示',
      icon: 'i-uim:box',
    },
    children: [
      MultilevelMenuExample,
      BreadcrumbExample,
      KeepAliveExample,
      // ...其他示例路由
    ],
  },
  {
    meta: {
      title: '生态',
      icon: 'i-icon-park-outline:circular-connection',
    },
    children: [
      ...EcologyExample,
    ],
  },
]
```

动态路由包括：
- **演示模块**: 包含各种功能演示页面
- **生态模块**: 包含第三方集成示例

## 路由生成方式

项目支持三种路由生成方式，通过 `settings.settings.app.routeBaseOn` 配置：

### 1. 前端路由 (frontend)

路由配置在前端定义，适合权限简单的应用：

```javascript
routeStore.generateRoutesAtFront(asyncRoutes)
```

### 2. 后端路由 (backend)

路由配置从后端获取，适合权限复杂的系统：

```javascript
await routeStore.generateRoutesAtBack()
```

### 3. 文件系统路由 (filesystem)

基于文件系统自动生成路由，适合快速开发：

```javascript
routeStore.generateRoutesAtFilesystem(asyncRoutesByFilesystem)
```

## 路由元信息 (meta)

路由元信息用于控制路由行为和展示：

```javascript
meta: {
  title: '页面标题',           // 页面标题
  icon: 'i-ant-design:home',   // 图标
  auth: ['permission.browse'], // 权限控制
  menu: false,                 // 是否在菜单中显示
  breadcrumb: false,           // 是否在面包屑中显示
  activeMenu: '/example',      // 激活的菜单项
  cache: true,                 // 是否缓存页面
  noCache: 'pageName',         // 不缓存的页面
}
```

### 常用元信息说明

- **title**: 页面标题，支持函数形式动态获取
- **icon**: 菜单图标，使用 Iconify 图标
- **auth**: 权限控制，可以是字符串或数组
- **menu**: 控制是否在菜单中显示
- **breadcrumb**: 控制是否在面包屑中显示
- **activeMenu**: 指定激活的菜单项
- **cache**: 控制页面是否缓存
- **noCache**: 指定不缓存的页面

## 路由守卫

路由守卫用于控制路由访问权限和行为：

### 1. 登录验证守卫

```javascript
router.beforeEach(async (to, _from, next) => {
  const userStore = useUserStore()
  
  // 检查是否已登录
  if (userStore.isLogin) {
    // 已登录逻辑
  } else {
    // 未登录逻辑，重定向到登录页
    if (to.name !== 'login') {
      next({
        name: 'login',
        query: {
          redirect: to.fullPath !== settingsStore.settings.home.fullPath ? to.fullPath : undefined,
        },
      })
    }
  }
})
```

### 2. 权限验证守卫

```javascript
// 获取用户权限
settingsStore.settings.app.enablePermission && await userStore.getPermissions()

// 根据权限生成路由
switch (settingsStore.settings.app.routeBaseOn) {
  case 'frontend':
    routeStore.generateRoutesAtFront(asyncRoutes)
    break
  case 'backend':
    await routeStore.generateRoutesAtBack()
    break
  case 'filesystem':
    routeStore.generateRoutesAtFilesystem(asyncRoutesByFilesystem)
    break
}
```

### 3. 进度条守卫

```javascript
const { isLoading } = useNProgress()

router.beforeEach((_to, _from, next) => {
  if (settingsStore.settings.app.enableProgress) {
    isLoading.value = true
  }
  next()
})

router.afterEach(() => {
  if (settingsStore.settings.app.enableProgress) {
    isLoading.value = false
  }
})
```

### 4. 标题守卫

```javascript
router.afterEach((to) => {
  settingsStore.setTitle(to.matched?.at(-1)?.meta?.title ?? to.meta.title)
})
```

### 5. 页面缓存守卫

```javascript
router.afterEach(async (to, from) => {
  const keepAliveStore = useKeepAliveStore()
  
  if (to.meta.cache) {
    const componentName = to.matched.at(-1)?.components?.default.name
    if (componentName) {
      // 缓存逻辑
      keepAliveStore.add(componentName)
    }
  }
})
```

## 路由模块化

路由采用模块化设计，每个功能模块独立定义路由：

### 多级菜单示例

```javascript
// src/router/modules/multilevel.menu.example.ts
const routes: RouteRecordRaw = {
  path: '/multilevel_menu_example',
  component: Layout,
  name: 'multilevelMenuExample',
  meta: {
    title: '多级导航',
    icon: 'i-heroicons-solid:menu-alt-3',
  },
  children: [
    {
      path: 'page',
      name: 'multilevelMenuExample1',
      component: () => import('@/views/multilevel_menu_example/page.vue'),
      meta: {
        title: '导航1',
      },
    },
    {
      path: 'level2',
      name: 'multilevelMenuExample2',
      meta: {
        title: '导航2',
      },
      children: [
        // 二级子路由
      ],
    },
  ],
}
```

### 权限控制示例

```javascript
// src/router/modules/permission.example.ts
const routes: RouteRecordRaw = {
  path: '/permission_example',
  component: Layout,
  name: 'permissionExample',
  meta: {
    title: '权限验证',
    icon: 'i-ri:shield-keyhole-line',
  },
  children: [
    {
      path: 'test',
      name: 'permissionExampleTest',
      component: () => import('@/views/permission_example/test.vue'),
      meta: {
        title: '测试页面',
        auth: ['permission.browse'], // 需要特定权限
        menu: false, // 不在菜单中显示
      },
    },
  ],
}
```

## 路由与菜单关联

路由与菜单通过以下方式关联：

1. **路由生成菜单**: 根据路由配置自动生成菜单
2. **菜单激活**: 根据当前路径激活对应菜单项
3. **面包屑导航**: 根据路由层级生成面包屑

```javascript
// 设置激活的菜单
menuStore.setActived(to.path)

// 生成菜单数据
switch (settingsStore.settings.menu.baseOn) {
  case 'frontend':
    menuStore.generateMenusAtFront()
    break
  case 'backend':
    await menuStore.generateMenusAtBack()
    break
}
```

## 路由扩展

### 1. 重定向权限子路由

当父级路由未配置重定向时，自动重定向到有访问权限的子路由：

```javascript
function setupRedirectAuthChildrenRoute(router: Router) {
  router.beforeEach((to, _from, next) => {
    const { auth } = useAuth()
    const currentRoute = router.getRoutes().find(route => route.path === (to.matched.at(-1)?.path ?? ''))
    
    if (!currentRoute?.redirect) {
      const findAuthRoute = currentRoute?.children?.find(route => 
        route.meta?.menu !== false && auth(route.meta?.auth ?? '')
      )
      if (findAuthRoute) {
        next(findAuthRoute)
      } else {
        next()
      }
    } else {
      next()
    }
  })
}
```

### 2. 路由扩展插件

支持通过插件扩展路由功能：

```javascript
// src/router/extensions.ts
export default function setupRouterExtensions(router: Router) {
  // 自定义路由扩展
}
```

## 路由配置最佳实践

### 1. 路由命名规范

- 使用驼峰命名法
- 模块名 + 功能名 + 类型名
- 例如：`userManagementList`, `orderDetailEdit`

### 2. 路由路径规范

- 使用小写字母和下划线
- 模块名/功能名
- 例如：`/user/list`, `/order/detail`

### 3. 组件懒加载

```javascript
component: () => import('@/views/example/index.vue')
```

### 4. 权限控制

```javascript
meta: {
  auth: ['user.browse'], // 需要用户浏览权限
}
```

### 5. 页面缓存

```javascript
meta: {
  cache: 'pageName', // 缓存页面
}
```

## 总结

本项目的路由系统设计灵活，支持多种路由生成方式和权限控制。通过路由守卫、元信息和模块化设计，实现了完整的路由管理功能。路由系统与菜单、权限、页面缓存等功能紧密结合，为应用提供了强大的导航和权限控制能力。