# 项目测试完整指南

## 📋 测试概览

本文档提供了项目所有模块的完整测试流程,确保系统功能正确、性能优良、安全可靠。

## 🎯 测试目标

1. ✅ 验证所有功能模块正常工作
2. ✅ 确保认证授权机制安全可靠
3. ✅ 验证性能指标符合要求
4. ✅ 保证用户体验流畅
5. ✅ 确保系统稳定性和可维护性

---

## 目录

- [第一部分: 核心功能测试](#第一部分-核心功能测试)
  - [1. 认证与授权测试](#1-认证与授权测试)
  - [2. 用户管理测试](#2-用户管理测试)
  - [3. 系统管理测试](#3-系统管理测试)
- [第二部分: 组件测试](#第二部分-组件测试)
  - [4. 基础组件测试](#4-基础组件测试)
  - [5. 业务组件测试](#5-业务组件测试)
- [第三部分: 性能与安全测试](#第三部分-性能与安全测试)
  - [6. 性能测试](#6-性能测试)
  - [7. 安全测试](#7-安全测试)
- [第四部分: 集成与端到端测试](#第四部分-集成与端到端测试)
  - [8. 集成测试](#8-集成测试)
  - [9. 端到端测试](#9-端到端测试)
- [附录](#附录)
  - [A. 测试环境配置](#a-测试环境配置)
  - [B. 测试报告模板](#b-测试报告模板)
  - [C. 常见问题解决](#c-常见问题解决)

---

# 第一部分: 核心功能测试

## 1. 认证与授权测试

### 1.1 Token 管理测试

#### 1.1.1 TokenService 单元测试

创建测试文件: `src/domains/shared/services/__tests__/TokenService.spec.ts`

```typescript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest'
import { tokenService } from '../TokenService'

describe('TokenService', () => {
  beforeEach(() => {
    tokenService.clearToken()
    sessionStorage.clear()
    vi.useFakeTimers()
  })

  afterEach(() => {
    vi.restoreAllMocks()
  })

  describe('基础功能', () => {
    it('应该能存储和读取 access token', () => {
      const tokenData = {
        token: 'test-access-token',
        refreshToken: 'test-refresh-token',
      }

      tokenService.setToken(tokenData)

      expect(tokenService.getAccessToken()).toBe('test-access-token')
      expect(tokenService.getRefreshToken()).toBe('test-refresh-token')
    })

    it('应该能正确判断 token 有效性', () => {
      expect(tokenService.hasValidToken()).toBe(false)

      tokenService.setToken({
        token: 'test-token',
        expiresAt: Date.now() + 3600000,
      })

      expect(tokenService.hasValidToken()).toBe(true)
    })

    it('应该能清除 token', () => {
      tokenService.setToken({ token: 'test-token' })
      expect(tokenService.hasValidToken()).toBe(true)

      tokenService.clearToken()
      
      expect(tokenService.hasValidToken()).toBe(false)
      expect(tokenService.getAccessToken()).toBeNull()
    })
  })

  describe('过期处理', () => {
    it('应该自动清除已过期的 token', () => {
      tokenService.setToken({
        token: 'expired-token',
        expiresAt: Date.now() - 1000,
      })

      expect(tokenService.hasValidToken()).toBe(false)
      expect(tokenService.getAccessToken()).toBeNull()
    })

    it('应该能检测即将过期的 token', () => {
      tokenService.setToken({
        token: 'expiring-token',
        expiresAt: Date.now() + 4 * 60 * 1000,
      })

      expect(tokenService.isTokenExpiringSoon()).toBe(true)
    })
  })

  describe('SessionStorage 集成', () => {
    it('应该将 token 备份到 sessionStorage', () => {
      tokenService.setToken({
        token: 'test-token',
        refreshToken: 'test-refresh',
      })

      const stored = sessionStorage.getItem('auth_session')
      expect(stored).not.toBeNull()
      
      const parsed = JSON.parse(stored!)
      expect(parsed.token).toBe('test-token')
    })

    it('清除 token 时应该同时清除 sessionStorage', () => {
      tokenService.setToken({ token: 'test-token' })
      expect(sessionStorage.getItem('auth_session')).not.toBeNull()

      tokenService.clearToken()
      
      expect(sessionStorage.getItem('auth_session')).toBeNull()
    })
  })
})
```

**运行测试:**
```bash
npm run test:unit -- TokenService.spec.ts
```

#### 1.1.2 Auth Store 测试

创建测试文件: `src/domains/auth/stores/__tests__/authStore.spec.ts`

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest'
import { setActivePinia, createPinia } from 'pinia'
import { useAuthStore } from '../authStore'
import { tokenService } from '@/domains/shared/services/TokenService'

vi.mock('../../services/authService', () => ({
  authService: {
    login: vi.fn(),
    refreshToken: vi.fn(),
    logout: vi.fn(),
  },
}))

describe('AuthStore', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
    tokenService.clearToken()
  })

  describe('登录流程', () => {
    it('成功登录应该保存 token 和用户信息', async () => {
      const store = useAuthStore()
      const mockResponse = {
        user: { id: 1, account: 'testuser', permissions: [] },
        token: 'new-token',
        refreshToken: 'new-refresh',
        expiresAt: new Date(Date.now() + 3600000).toISOString(),
      }

      const { authService } = await import('../../services/authService')
      vi.mocked(authService.login).mockResolvedValue(mockResponse)

      await store.login({ account: 'testuser', password: 'password' })

      expect(store.isAuthenticated).toBe(true)
      expect(store.token).toBe('new-token')
      expect(tokenService.getAccessToken()).toBe('new-token')
    })
  })

  describe('登出流程', () => {
    it('应该清除所有认证状态', async () => {
      const store = useAuthStore()
      
      tokenService.setToken({ token: 'test-token' })
      store.isAuthenticated = true

      await store.logout()

      expect(store.isAuthenticated).toBe(false)
      expect(tokenService.getAccessToken()).toBeNull()
    })
  })
})
```

### 1.2 登录功能测试

#### 手动测试步骤

**步骤 1: 正常登录**

1. 访问 `http://localhost:5173/login`
2. 输入账号: `admin`
3. 输入密码: `admin123`
4. 点击登录

**验证:**
```javascript
console.log('Token:', window.__tokenService?.getAccessToken())
console.log('SessionStorage:', sessionStorage.getItem('auth_session'))
```

**预期结果:**
- ✅ 跳转到首页
- ✅ Token 存储在内存
- ✅ SessionStorage 有备份

**步骤 2: 错误处理**

测试场景:
- 空账号/密码
- 错误的凭据
- 网络错误

**预期结果:**
- ✅ 显示适当的错误提示
- ✅ 不存储无效 token
- ✅ 表单保持可用

### 1.3 权限控制测试

#### 1.3.1 路由权限测试

```typescript
// src/domains/auth/__tests__/permission.spec.ts
import { describe, it, expect, beforeEach } from 'vitest'
import { setActivePinia, createPinia } from 'pinia'
import { useAuthStore } from '../stores/authStore'
import { hasPermission } from '../utils/permission'

describe('权限控制', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
  })

  it('应该正确验证用户权限', () => {
    const store = useAuthStore()
    store.user = {
      id: 1,
      account: 'testuser',
      permissions: ['user:read', 'user:write']
    }

    expect(hasPermission('user:read')).toBe(true)
    expect(hasPermission('user:delete')).toBe(false)
  })

  it('超级管理员应该拥有所有权限', () => {
    const store = useAuthStore()
    store.user = {
      id: 1,
      account: 'admin',
      permissions: ['*']
    }

    expect(hasPermission('any:permission')).toBe(true)
  })
})
```

#### 1.3.2 手动测试

**测试场景 1: 访问受保护的路由**

1. 未登录状态访问 `/system/security`
2. **预期:** 重定向到登录页

**测试场景 2: 权限不足**

1. 使用普通用户登录
2. 尝试访问管理员页面
3. **预期:** 显示权限不足提示

---

## 2. 用户管理测试

### 2.1 用户列表测试

#### 2.1.1 数据加载测试

```typescript
// src/domains/user/__tests__/userList.spec.ts
import { describe, it, expect, vi } from 'vitest'
import { mount } from '@vue/test-utils'
import UserList from '@/views/user/list.vue'

describe('用户列表', () => {
  it('应该能加载用户列表', async () => {
    const mockUsers = [
      { id: 1, account: 'user1', name: 'User One' },
      { id: 2, account: 'user2', name: 'User Two' },
    ]

    vi.mock('@/domains/user/services/userService', () => ({
      userService: {
        getUsers: vi.fn().mockResolvedValue(mockUsers),
      },
    }))

    const wrapper = mount(UserList)
    await wrapper.vm.$nextTick()

    expect(wrapper.findAll('.user-item')).toHaveLength(2)
  })
})
```

#### 2.1.2 手动测试

**步骤:**

1. 访问用户管理页面
2. 验证用户列表显示
3. 测试分页功能
4. 测试搜索功能
5. 测试筛选功能

**预期结果:**
- ✅ 用户列表正确显示
- ✅ 分页切换正常
- ✅ 搜索结果准确
- ✅ 筛选功能有效

### 2.2 用户CRUD测试

#### 创建用户

```javascript
// 控制台测试
const newUser = {
  account: 'testuser',
  name: 'Test User',
  email: 'test@example.com',
  password: 'password123'
}

// 调用创建接口
await userService.createUser(newUser)
```

**验证:**
- ✅ 用户成功创建
- ✅ 列表自动刷新
- ✅ 表单重置

#### 编辑用户

**测试步骤:**
1. 点击用户编辑按钮
2. 修改用户信息
3. 保存更改

**验证:**
- ✅ 数据正确保存
- ✅ 列表更新
- ✅ 成功提示

#### 删除用户

**测试步骤:**
1. 选择用户
2. 点击删除
3. 确认删除

**验证:**
- ✅ 用户被删除
- ✅ 列表更新
- ✅ 提示正确

---

## 3. 系统管理测试

### 3.1 系统监控测试

创建测试文件: `src/domains/system/__tests__/monitoring.spec.ts`

```typescript
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import Monitoring from '@/views/system/monitoring/index.vue'

describe('系统监控', () => {
  it('应该能显示系统指标', async () => {
    const wrapper = mount(Monitoring)
    await wrapper.vm.$nextTick()

    expect(wrapper.find('.cpu-usage').exists()).toBe(true)
    expect(wrapper.find('.memory-usage').exists()).toBe(true)
    expect(wrapper.find('.disk-usage').exists()).toBe(true)
  })

  it('应该能实时更新数据', async () => {
    vi.useFakeTimers()
    
    const wrapper = mount(Monitoring)
    const initialCpu = wrapper.vm.cpuUsage

    // 等待自动刷新
    await vi.advanceTimersByTimeAsync(5000)

    const updatedCpu = wrapper.vm.cpuUsage
    expect(updatedCpu).not.toBe(initialCpu)

    vi.useRealTimers()
  })
})
```

### 3.2 系统安全测试

#### 手动测试

**功能清单:**
- [ ] 安全设置页面加载正常
- [ ] 密码策略配置有效
- [ ] 登录限制功能正常
- [ ] 会话管理正确
- [ ] 操作日志记录完整

### 3.3 备份恢复测试

**测试场景:**

1. **创建备份**
   - 点击创建备份
   - 验证备份文件生成
   - 检查备份列表

2. **恢复备份**
   - 选择备份文件
   - 执行恢复操作
   - 验证数据恢复

3. **定时备份**
   - 配置定时任务
   - 验证自动执行
   - 检查备份结果

### 3.4 系统更新测试

**测试步骤:**

1. 检查更新
2. 下载更新包
3. 执行更新
4. 验证更新结果
5. 回滚测试

---

# 第二部分: 组件测试

## 4. 基础组件测试

### 4.1 表单组件测试

#### Input 组件

```typescript
// src/components/__tests__/Input.spec.ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import Input from '@/components/ui/input.vue'

describe('Input 组件', () => {
  it('应该能正确显示初始值', () => {
    const wrapper = mount(Input, {
      props: { modelValue: 'test value' }
    })

    expect(wrapper.find('input').element.value).toBe('test value')
  })

  it('应该能触发 update:modelValue 事件', async () => {
    const wrapper = mount(Input)
    const input = wrapper.find('input')

    await input.setValue('new value')

    expect(wrapper.emitted('update:modelValue')).toBeTruthy()
    expect(wrapper.emitted('update:modelValue')?.[0]).toEqual(['new value'])
  })

  it('应该支持禁用状态', () => {
    const wrapper = mount(Input, {
      props: { disabled: true }
    })

    expect(wrapper.find('input').attributes('disabled')).toBeDefined()
  })
})
```

#### Button 组件

```typescript
describe('Button 组件', () => {
  it('应该能正确渲染', () => {
    const wrapper = mount(Button, {
      slots: { default: 'Click Me' }
    })

    expect(wrapper.text()).toBe('Click Me')
  })

  it('应该能触发点击事件', async () => {
    const wrapper = mount(Button)
    
    await wrapper.trigger('click')

    expect(wrapper.emitted('click')).toBeTruthy()
  })

  it('禁用状态不应触发点击', async () => {
    const wrapper = mount(Button, {
      props: { disabled: true }
    })

    await wrapper.trigger('click')

    expect(wrapper.emitted('click')).toBeFalsy()
  })
})
```

### 4.2 数据展示组件测试

#### Table 组件

```typescript
describe('Table 组件', () => {
  const mockData = [
    { id: 1, name: 'Item 1', status: 'active' },
    { id: 2, name: 'Item 2', status: 'inactive' },
  ]

  it('应该能正确渲染数据', () => {
    const wrapper = mount(Table, {
      props: {
        data: mockData,
        columns: [
          { key: 'id', title: 'ID' },
          { key: 'name', title: 'Name' },
        ]
      }
    })

    expect(wrapper.findAll('tbody tr')).toHaveLength(2)
  })

  it('应该支持排序功能', async () => {
    const wrapper = mount(Table, {
      props: {
        data: mockData,
        columns: [
          { key: 'name', title: 'Name', sortable: true }
        ]
      }
    })

    const sortButton = wrapper.find('.sort-button')
    await sortButton.trigger('click')

    expect(wrapper.emitted('sort')).toBeTruthy()
  })
})
```

### 4.3 反馈组件测试

#### Modal 组件

```typescript
describe('Modal 组件', () => {
  it('应该能控制显示隐藏', async () => {
    const wrapper = mount(Modal, {
      props: { visible: false }
    })

    expect(wrapper.find('.modal').isVisible()).toBe(false)

    await wrapper.setProps({ visible: true })

    expect(wrapper.find('.modal').isVisible()).toBe(true)
  })

  it('应该能触发关闭事件', async () => {
    const wrapper = mount(Modal, {
      props: { visible: true }
    })

    await wrapper.find('.close-button').trigger('click')

    expect(wrapper.emitted('close')).toBeTruthy()
  })
})
```

---

## 5. 业务组件测试

### 5.1 页面头部测试

```typescript
describe('PageHeader 组件', () => {
  it('应该显示标题和面包屑', () => {
    const wrapper = mount(PageHeader, {
      props: {
        title: 'Test Page',
        breadcrumb: ['Home', 'Test']
      }
    })

    expect(wrapper.find('h1').text()).toBe('Test Page')
    expect(wrapper.findAll('.breadcrumb-item')).toHaveLength(2)
  })
})
```

### 5.2 搜索栏测试

```typescript
describe('SearchBar 组件', () => {
  it('应该能触发搜索事件', async () => {
    const wrapper = mount(SearchBar)
    
    await wrapper.find('input').setValue('test query')
    await wrapper.find('form').trigger('submit')

    expect(wrapper.emitted('search')).toBeTruthy()
  })
})
```

---

# 第三部分: 性能与安全测试

## 6. 性能测试

### 6.1 响应时间测试

```typescript
describe('性能测试', () => {
  it('Token 操作应该快速完成', () => {
    console.time('setToken')
    tokenService.setToken({ token: 'test', refreshToken: 'test' })
    console.timeEnd('setToken')
    // 预期: < 1ms

    console.time('getToken')
    tokenService.getAccessToken()
    console.timeEnd('getToken')
    // 预期: < 0.1ms
  })
})
```

### 6.2 内存泄漏测试

```javascript
// 浏览器控制台测试
console.log('Initial:', performance.memory?.usedJSHeapSize)

// 执行大量操作
for (let i = 0; i < 100; i++) {
  tokenService.setToken({ token: `test-${i}` })
  tokenService.clearToken()
}

console.log('After:', performance.memory?.usedJSHeapSize)
```

### 6.3 打包体积测试

```bash
npm run build
npm run build:analyze
```

**检查项:**
- ✅ 总体积 < 500KB (gzip)
- ✅ 主包 < 200KB
- ✅ 无重复依赖

---

## 7. 安全测试

### 7.1 XSS 防护测试

**测试场景:**

```javascript
// 尝试在输入框输入
const xssPayload = '<script>alert("XSS")</script>'
// 预期: 脚本被转义,不执行
```

### 7.2 CSRF 防护测试

```javascript
// Token 不存储在 Cookie
console.log('Cookies:', document.cookie)
// 预期: 不包含 token
```

### 7.3 权限绕过测试

```javascript
// 未登录访问 API
fetch('/api/admin/users')
// 预期: 401 Unauthorized
```

---

# 第四部分: 集成与端到端测试

## 8. 集成测试

### 8.1 完整登录流程

```typescript
describe('认证流程集成测试', () => {
  it('完整登录流程', async () => {
    // 1. 渲染登录页
    // 2. 输入凭据
    // 3. 提交登录
    // 4. 验证 token 存储
    // 5. 验证 session 备份
    // 6. 验证路由跳转
  })
})
```

### 8.2 页面刷新状态恢复

```typescript
describe('页面刷新状态恢复', () => {
  it('应该从 sessionStorage 恢复认证状态', async () => {
    // 1. 设置认证状态
    // 2. 模拟页面刷新
    // 3. 验证状态恢复
  })
})
```

---

## 9. 端到端测试

### 9.1 用户完整工作流

**场景: 管理员管理用户**

1. 登录系统
2. 进入用户管理
3. 创建新用户
4. 编辑用户信息
5. 删除用户
6. 登出系统

**每步验证:**
- 页面加载正常
- 操作成功执行
- 数据正确更新
- 提示信息准确

---

# 附录

## A. 测试环境配置

### 单元测试配置

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  test: {
    globals: true,
    environment: 'jsdom',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
    },
  },
})
```

### E2E测试配置

```typescript
// playwright.config.ts
import { defineConfig } from '@playwright/test'

export default defineConfig({
  testDir: './tests/e2e',
  use: {
    baseURL: 'http://localhost:5173',
    screenshot: 'only-on-failure',
  },
})
```

## B. 测试报告模板

```markdown
# 测试报告

**测试日期:** YYYY-MM-DD
**测试人员:** XXX
**测试环境:** 开发/测试/生产

## 测试概要

- 计划测试: XX 项
- 实际完成: XX 项
- 通过: XX 项
- 失败: XX 项
- 阻塞: XX 项

## 详细结果

### 1. 认证测试
- [✅] 登录功能
- [✅] 登出功能
- [❌] Token 刷新 - 需要修复

### 2. 用户管理
- [✅] 列表展示
- [✅] 创建用户
- [⚠️] 删除用户 - 有警告

## 问题列表

| ID | 严重程度 | 描述 | 状态 |
|----|---------|------|------|
| 1  | 高      | Token 刷新失败 | 待修复 |
| 2  | 中      | 删除提示不明确 | 待优化 |

## 建议

1. 修复 Token 刷新机制
2. 优化用户交互提示
3. 增加错误日志
```

## C. 常见问题解决

### 问题1: 测试环境 Token 过期

**解决方案:**
```javascript
// 使用固定的测试 token
const TEST_TOKEN = 'test-token-' + Date.now()
tokenService.setToken({
  token: TEST_TOKEN,
  expiresAt: Date.now() + 24 * 3600000 // 24小时
})
```

### 问题2: Mock 数据不生效

**解决方案:**
```typescript
// 确保 mock 在测试前声明
vi.mock('@/api/user', () => ({
  getUsers: vi.fn().mockResolvedValue([...])
}))
```

### 问题3: 组件渲染失败

**解决方案:**
```typescript
// 提供必要的全局依赖
mount(Component, {
  global: {
    plugins: [createPinia(), router],
    stubs: {
      'router-link': true
    }
  }
})
```

---

## 📊 测试检查清单

### 核心功能 (必测)

- [ ] 登录/登出
- [ ] Token 管理
- [ ] 权限控制
- [ ] 用户管理
- [ ] 系统设置

### 组件功能 (重点)

- [ ] 基础组件
- [ ] 表单验证
- [ ] 数据展示
- [ ] 交互反馈

### 性能指标 (重要)

- [ ] 响应时间 < 200ms
- [ ] 打包体积 < 500KB
- [ ] 首屏加载 < 2s

### 安全验证 (关键)

- [ ] XSS 防护
- [ ] CSRF 防护
- [ ] SQL 注入防护
- [ ] 权限绕过测试

---

## 🎯 测试执行命令

```bash
# 运行所有测试
npm run test

# 运行单元测试
npm run test:unit

# 运行集成测试
npm run test:integration

# 运行 E2E 测试
npm run test:e2e

# 生成覆盖率报告
npm run test:coverage

# 监听模式
npm run test:watch
```

---

## 📝 测试注意事项

1. **测试独立性:** 每个测试应该独立运行,不依赖其他测试
2. **数据清理:** 测试后清理测试数据,避免污染
3. **Mock 使用:** 合理使用 Mock,但不要过度 Mock
4. **断言清晰:** 断言应该清晰表达预期结果
5. **错误处理:** 测试应该包含错误场景
6. **性能考虑:** 避免测试执行时间过长
7. **文档同步:** 保持测试文档与代码同步

---

**文档版本:** v1.0  
**最后更新:** 2025-10-25  
**维护者:** 开发团队